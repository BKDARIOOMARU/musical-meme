name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'mobile/package-lock.json'
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Android SDK
      uses: android-actions/setup-android@v2
    
    - name: Install mobile dependencies
      working-directory: ./mobile
      run: npm ci
    
    - name: Create web directory for Capacitor
      run: mkdir -p mobile/www && echo '<!DOCTYPE html><html><head><title>AI Music Generator</title></head><body><div id="root"></div><script src="main.js"></script></body></html>' > mobile/www/index.html
    
    - name: Add Android platform to Capacitor
      working-directory: ./mobile
      run: |
        npx cap add android --web-dir=www || echo "Android platform already exists"
    
    - name: Sync Capacitor
      working-directory: ./mobile
      run: npx cap sync android
    
    - name: Build Android APK (Debug)
      working-directory: ./mobile/android
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
    
    - name: Build Android APK (Release)
      working-directory: ./mobile/android
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: Upload Release APK (unsigned)
      uses: actions/upload-artifact@v3
      with:
        name: app-release-unsigned
        path: mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
    
    - name: Create Release Notes
      run: |
        cat > release-notes.txt << 'EOF'
        AI Music Generator - APK Build
        
        Debug APK: app-debug.apk (ready to install on device)
        Release APK: app-release-unsigned.apk (sign before Play Store submission)
        
        Features:
        - Instrumental synthesis (5 genres)
        - Lyrics to vocals (TTS + pitch modulation)
        - Random mode (procedural composition)
        - Fast preview (cached generation)
        - WAV/MP3 download
        
        Installation:
        1. Download app-debug.apk
        2. Connect Android device with USB debugging enabled
        3. Run: adb install app-debug.apk
        
        For Play Store:
        1. Download app-release-unsigned.apk
        2. Sign with your keystore
        3. Upload to Google Play Console
        
        Build date: $(date)
        Commit: ${{ github.sha }}
        EOF
    
    - name: Upload Release Notes
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release-notes.txt
        retention-days: 30

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: python scripts/test_app.py
